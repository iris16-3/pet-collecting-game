<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pet Collector — Create & Play</title>
<style>
:root{--bg:#fff;--muted:#666;--accent:#0b67ff}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);padding:18px;color:#111;overflow-x:hidden}
header{display:flex;gap:8px;align-items:center;margin-bottom:14px}
h1{font-size:18px;margin:0}
.btn{padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:0}
main{max-width:1200px;margin:0 auto}
.container{display:grid;grid-template-columns:360px 1fr;gap:16px}
.card{border:1px solid #ddd;border-radius:8px;padding:12px;background:#fff}
label{display:block;font-size:13px;margin:6px 0;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}.muted{color:var(--muted)}.row{display:flex;gap:6px;align-items:center}
.inv-item,.egg-item,.pet-item,.acct-item{border:1px dashed #ccc;padding:6px;border-radius:6px;margin:4px 0;background:#fbfbff}
.trade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px}
.trade-slot{border:1px dashed #ccc;height:60px;display:flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;background:#fafafa}
.trade-slot.filled{background:#eaf3ff;font-weight:600}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:18px}
#modal>div{background:#fff;padding:12px;border-radius:8px;max-width:900px;width:100%;max-height:85%;overflow:auto}
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;max-height:260px;overflow:auto;padding:6px}
.inv-card{border:1px solid #e6e6e6;border-radius:10px;padding:10px;background:#fbfbff;display:flex;flex-direction:column;gap:6px;min-height:100px}
.shop-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.shop-card{border:1px solid #e6e6e6;border-radius:10px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:8px;min-height:120px}
.pet-line{font-size:13px;color:var(--muted)}
.visibility-badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #ddd}
.trade-total{font-weight:700;padding:6px 8px;border-radius:8px;background:#f1f7ff;border:1px solid #ddd}
.net-diff{font-weight:700;padding:6px 8px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:8px}
.net-pos{color:green;font-weight:700}
.net-neg{color:red;font-weight:700}
.json-textarea{width:100%;height:220px;border:1px solid #ddd;padding:8px;border-radius:6px}
@media (max-width:900px){
  .container{grid-template-columns:1fr;}
  header .row{flex-wrap:wrap}
  .trade-grid{grid-template-columns:repeat(3,1fr);gap:6px}
}
</style>
</head>
<body>
<header>
  <h1>Pet Collector</h1>
  <div class="row" style="margin-left:auto">
    <button id="bCreate" class="btn">Create</button>
    <button id="bPlay" class="btn">Play</button>
    <button id="bTrade" class="btn">Trade</button>
    <button id="bExport" class="btn">Export</button>
    <button id="bImport" class="btn">Import</button>
  </div>
</header>
<main class="container"><section class="card" id="L"></section><section class="card" id="R"></section></main>
<div id="modal"><div><h3 id="modalTitle"></h3><div id="modalBody"></div><div class="row" style="justify-content:end;margin-top:8px"><button id="modalClose" class="btn">Cancel</button></div></div></div>
<script>
const S_EGGS='petgame_eggs', S_ACCTS='petgame_accounts';
const L=document.getElementById('L'), R=document.getElementById('R');
const bCreate=document.getElementById('bCreate'), bPlay=document.getElementById('bPlay'), bTrade=document.getElementById('bTrade');
const bExport=document.getElementById('bExport'), bImport=document.getElementById('bImport');
const M=document.getElementById('modal'), MT=document.getElementById('modalTitle'), MB=document.getElementById('modalBody'), MClose=document.getElementById('modalClose');
const load=k=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
let eggs=load(S_EGGS), accounts=load(S_ACCTS), mode='create', selectedEggId=null, selectedAccountId=null;
let trade={acc1:null,acc2:null,slots1:Array(9).fill(null),slots2:Array(9).fill(null)}, inventoryScroll={};
const uid=(p='id')=>p+'_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*9000);
const esc=s=>s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'', btn=(t,c,f)=>{const b=document.createElement('button');b.className='btn '+(c||'');b.textContent=t;b.addEventListener('click',f);return b};
const openModal=(title,nodes)=>{MT.textContent=title;MB.innerHTML='';nodes.forEach(n=>MB.appendChild(n));M.style.display='flex'};
const closeModal=()=>{M.style.display='none';MB.innerHTML=''};MClose.addEventListener('click',closeModal);

bExport.addEventListener('click',exportData);bImport.addEventListener('click',openImportModal);
function exportData(){const payload={eggs,accounts,exportedAt:Date.now()};const json=JSON.stringify(payload,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='petgame_data_'+(new Date()).toISOString().replace(/[:.]/g,'-')+'.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);const cont=document.createElement('div');const ta=document.createElement('textarea');ta.className='json-textarea';ta.value=json;const copyBtn=btn('Copy JSON','',()=>{ta.select();document.execCommand('copy');alert('JSON copied')});cont.appendChild(ta);cont.appendChild(document.createElement('br'));cont.appendChild(copyBtn);openModal('Exported data', [cont])}
function openImportModal(){const cont=document.createElement('div');const ta=document.createElement('textarea');ta.className='json-textarea';ta.placeholder='Paste exported JSON...';const imp=btn('Import JSON','primary',()=>{const raw=ta.value.trim();if(!raw)return alert('Paste JSON');try{const parsed=JSON.parse(raw);if(parsed.eggs&&parsed.accounts){eggs=parsed.eggs;accounts=parsed.accounts;save(S_EGGS,eggs);save(S_ACCTS,accounts);closeModal();render();alert('Import OK')}else{if(confirm('Missing top-level eggs/accounts. Try best-effort import?')){if(Array.isArray(parsed)){eggs=parsed;save(S_EGGS,eggs);closeModal();render();alert('Imported into eggs (best-effort)')}else alert('Invalid structure')}}}catch(e){alert('Invalid JSON: '+e.message)}});cont.appendChild(ta);cont.appendChild(document.createElement('br'));cont.appendChild(imp);openModal('Import data', [cont])}

function render(){bCreate.classList.toggle('primary',mode==='create');bPlay.classList.toggle('primary',mode==='play');bTrade.classList.toggle('primary',mode==='trade');if(mode==='create')renderCreate();else if(mode==='play')renderPlay();else renderTrade()}

function renderCreate(){L.innerHTML='';R.innerHTML='';L.appendChild(Object.assign(document.createElement('h3'),{textContent:'Create Mode'}));
  const lbl=document.createElement('label');lbl.textContent='Egg name';const nameIn=document.createElement('input');nameIn.placeholder='Mystic Egg';const lp=document.createElement('label');lp.textContent='Egg price (coins)';const priceIn=document.createElement('input');priceIn.type='number';priceIn.value=100;L.appendChild(lbl);L.appendChild(nameIn);L.appendChild(lp);L.appendChild(priceIn);
  const r=document.createElement('div');r.className='row';r.style.marginTop='8px';r.appendChild(btn('Add Egg','primary',()=>{const name=nameIn.value.trim(),price=Number(priceIn.value)||0;if(!name)return alert('Enter egg name');const e={id:uid('egg'),name,price,pets:[],visible:true};eggs.push(e);save(S_EGGS,eggs);selectedEggId=e.id;render()}));r.appendChild(btn('Export eggs JSON','',()=>{prompt('Eggs JSON',JSON.stringify(eggs,null,2))}));L.appendChild(r);
  L.appendChild(Object.assign(document.createElement('h4'),{textContent:'Your Eggs'}));const list=document.createElement('div');if(!eggs.length)list.innerHTML='<div class="muted">No eggs yet.</div>';else eggs.forEach(egg=>{if(egg.visible===undefined)egg.visible=true;const el=document.createElement('div');el.className='egg-item row';el.style.justifyContent='space-between';const left=document.createElement('div');left.style.flex='1';left.innerHTML=`<strong>${esc(egg.name)}</strong><div class="small">Price: ${egg.price} — Pets: ${egg.pets.length}</div>`;const ctr=document.createElement('div');ctr.className='row';ctr.appendChild(btn('Edit','',()=>{selectedEggId=egg.id;render()}));ctr.appendChild(btn('Delete','',()=>{if(confirm('Delete egg and pets?')){eggs=eggs.filter(e=>e.id!==egg.id);save(S_EGGS,eggs);if(selectedEggId===egg.id)selectedEggId=null;render()}}));ctr.appendChild(btn(egg.visible?'Visible':'Hidden','',()=>{egg.visible=!egg.visible;save(S_EGGS,eggs);render()}));el.appendChild(left);el.appendChild(ctr);list.appendChild(el)});L.appendChild(list);
  if(selectedEggId){const egg=eggs.find(e=>e.id===selectedEggId);if(egg)renderEggEditor(egg);else{selectedEggId=null;R.innerHTML='<div class="muted">Select an egg</div>'}}else R.innerHTML='<div class="muted">Select an egg to edit</div>'}

function renderEggEditor(egg){R.innerHTML='';R.appendChild(Object.assign(document.createElement('h3'),{textContent:'Editing: '+egg.name}));const lp=document.createElement('label');lp.textContent='Egg price';const inPrice=document.createElement('input');inPrice.type='number';inPrice.value=egg.price;R.appendChild(lp);R.appendChild(inPrice);const vr=document.createElement('div');vr.className='row';vr.style.marginTop='6px';const vl=document.createElement('label');vl.textContent='Visible in shop';vr.appendChild(vl);vr.appendChild(btn(egg.visible?'Visible':'Hidden','',()=>{egg.visible=!egg.visible;save(S_EGGS,eggs);render()}));R.appendChild(vr);const rr=document.createElement('div');rr.className='row';rr.style.marginTop='8px';rr.appendChild(btn('Save Egg','primary',()=>{egg.price=Number(inPrice.value)||0;save(S_EGGS,eggs);render()}));rr.appendChild(btn('Back to eggs','',()=>{selectedEggId=null;render()}));R.appendChild(rr);
  R.appendChild(Object.assign(document.createElement('h4'),{textContent:"Pets in this egg (order doesn't matter)"}));const petList=document.createElement('div');if(!egg.pets||!egg.pets.length)petList.innerHTML='<div class="muted">No pets yet.</div>';else egg.pets.forEach(p=>{const d=document.createElement('div');d.className='pet-item';d.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><div style="flex:1"><strong>${esc(p.name)}</strong> <span class="small">(${esc(p.rarityText)} — ${p.rarityPct}%)</span><div class="small muted">Weight: ${p.weightMin}kg - ${p.weightMax}kg • Money/tap: ${p.moneyPerTap}</div><div class="small">Values: ${Number(p.valueRegular||0)} / G:${Number(p.valueGold||0)} / R:${Number(p.valueRainbow||0)}</div><div class="small">${esc(p.description||'')}</div></div></div>`;const ctr=document.createElement('div');ctr.className='inline-controls';ctr.appendChild(btn('Edit','',()=>showPetEditModal(egg,p)));ctr.appendChild(btn('Delete','',()=>{if(confirm('Delete this pet?')){egg.pets=egg.pets.filter(x=>x.id!==p.id);save(S_EGGS,eggs);render()}}));d.appendChild(ctr);petList.appendChild(d)});R.appendChild(petList);
  R.appendChild(Object.assign(document.createElement('h4'),{textContent:'Add a new Pet'}));
  const f={};f.name=document.createElement('input');f.name.placeholder='Pet name';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Name'}));R.appendChild(f.name);
  f.rtext=document.createElement('input');f.rtext.placeholder='Rarity text';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Rarity text'}));R.appendChild(f.rtext);
  f.rpct=document.createElement('input');f.rpct.type='number';f.rpct.placeholder='Rarity %';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Rarity percentage (0-100)'}));R.appendChild(f.rpct);
  f.desc=document.createElement('textarea');f.desc.placeholder='A short description';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Description'}));R.appendChild(f.desc);
  f.wmin=document.createElement('input');f.wmin.type='number';f.wmin.step='0.1';f.wmin.placeholder='Weight min';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Weight min (kg)'}));R.appendChild(f.wmin);
  f.wmax=document.createElement('input');f.wmax.type='number';f.wmax.step='0.1';f.wmax.placeholder='Weight max';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Weight max (kg)'}));R.appendChild(f.wmax);
  f.mpt=document.createElement('input');f.mpt.type='number';f.mpt.step='0.01';f.mpt.placeholder='Money per tap';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Money earn per tap (baseline)'}));R.appendChild(f.mpt);
  f.gold=document.createElement('input');f.gold.type='number';f.gold.placeholder='Gold chance %';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Gold chance (%)'}));R.appendChild(f.gold);
  f.rainbow=document.createElement('input');f.rainbow.type='number';f.rainbow.placeholder='Rainbow chance %';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Rainbow chance (%)'}));R.appendChild(f.rainbow);
  f.valReg=document.createElement('input');f.valReg.type='number';f.valReg.step='0.01';f.valReg.placeholder='Regular value';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Regular trade value'}));R.appendChild(f.valReg);
  f.valGold=document.createElement('input');f.valGold.type='number';f.valGold.step='0.01';f.valGold.placeholder='Gold value';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Gold trade value'}));R.appendChild(f.valGold);
  f.valRainbow=document.createElement('input');f.valRainbow.type='number';f.valRainbow.step='0.01';f.valRainbow.placeholder='Rainbow value';R.appendChild(Object.assign(document.createElement('label'),{textContent:'Rainbow trade value'}));R.appendChild(f.valRainbow);
  R.appendChild(btn('Add Pet','primary',()=>{const name=f.name.value.trim();const rtext=f.rtext.value.trim()||'Common';const rpct=Number(f.rpct.value)||0;const descr=f.desc.value.trim();const wmin=Number(f.wmin.value)||0;const wmax=Number(f.wmax.value)||0;const mpt=Number(f.mpt.value)||0;const goldPct=Number(f.gold.value)||0;const rainbowPct=Number(f.rainbow.value)||0;const valueRegular=Number(f.valReg.value)||0;const valueGold=Number(f.valGold.value)||0;const valueRainbow=Number(f.valRainbow.value)||0;if(!name)return alert('Enter pet name');if(wmax<wmin)return alert('Weight max must be >= min');const otherTotal=(egg.pets||[]).reduce((s,p)=>s+(p.rarityPct||0),0);if(otherTotal+rpct>100){if(!confirm('Total rarity % will exceed 100%. Continue?'))return}const p={id:uid('pet'),name,rarityText:rtext,rarityPct:rpct,description:descr,weightMin:wmin,weightMax:wmax,moneyPerTap:mpt,goldPct:goldPct,rainbowPct:rainbowPct,valueRegular:valueRegular,valueGold:valueGold,valueRainbow:valueRainbow};egg.pets.push(p);save(S_EGGS,eggs);render()}));}

function showPetEditModal(egg,pet){const cont=document.createElement('div');cont.innerHTML='<h4>Edit Pet</h4>';
  const inName=document.createElement('input');inName.value=pet.name;cont.appendChild(document.createTextNode('Name'));cont.appendChild(inName);cont.appendChild(document.createElement('br'));
  const inRtext=document.createElement('input');inRtext.value=pet.rarityText;cont.appendChild(document.createTextNode('Rarity text'));cont.appendChild(inRtext);cont.appendChild(document.createElement('br'));
  const inRp=document.createElement('input');inRp.type='number';inRp.value=pet.rarityPct;cont.appendChild(document.createTextNode('Rarity %'));cont.appendChild(inRp);cont.appendChild(document.createElement('br'));
  const inDesc=document.createElement('textarea');inDesc.value=pet.description;cont.appendChild(document.createTextNode('Description'));cont.appendChild(inDesc);cont.appendChild(document.createElement('br'));
  const inWmin=document.createElement('input');inWmin.type='number';inWmin.step='0.1';inWmin.value=pet.weightMin;cont.appendChild(document.createTextNode('Weight min'));cont.appendChild(inWmin);cont.appendChild(document.createElement('br'));
  const inWmax=document.createElement('input');inWmax.type='number';inWmax.step='0.1';inWmax.value=pet.weightMax;cont.appendChild(document.createTextNode('Weight max'));cont.appendChild(inWmax);cont.appendChild(document.createElement('br'));
  const inMpt=document.createElement('input');inMpt.type='number';inMpt.step='0.01';inMpt.value=pet.moneyPerTap;cont.appendChild(document.createTextNode('Money per tap'));cont.appendChild(inMpt);cont.appendChild(document.createElement('br'));
  const inGold=document.createElement('input');inGold.type='number';inGold.value=pet.goldPct||0;cont.appendChild(document.createTextNode('Gold chance (%)'));cont.appendChild(inGold);cont.appendChild(document.createElement('br'));
  const inRainbow=document.createElement('input');inRainbow.type='number';inRainbow.value=pet.rainbowPct||0;cont.appendChild(document.createTextNode('Rainbow chance (%)'));cont.appendChild(inRainbow);cont.appendChild(document.createElement('br'));
  const inValReg=document.createElement('input');inValReg.type='number';inValReg.step='0.01';inValReg.value=pet.valueRegular||0;cont.appendChild(document.createTextNode('Regular trade value'));cont.appendChild(inValReg);cont.appendChild(document.createElement('br'));
  const inValGold=document.createElement('input');inValGold.type='number';inValGold.step='0.01';inValGold.value=pet.valueGold||0;cont.appendChild(document.createTextNode('Gold trade value'));cont.appendChild(inValGold);cont.appendChild(document.createElement('br'));
  const inValRainbow=document.createElement('input');inValRainbow.type='number';inValRainbow.step='0.01';inValRainbow.value=pet.valueRainbow||0;cont.appendChild(document.createTextNode('Rainbow trade value'));cont.appendChild(inValRainbow);cont.appendChild(document.createElement('br'));
  cont.appendChild(btn('Save Pet','primary',()=>{pet.name=inName.value.trim()||pet.name;pet.rarityText=inRtext.value.trim()||pet.rarityText;pet.rarityPct=Number(inRp.value)||0;pet.description=inDesc.value.trim();pet.weightMin=Number(inWmin.value)||0;pet.weightMax=Number(inWmax.value)||0;pet.moneyPerTap=Number(inMpt.value)||0;pet.goldPct=Number(inGold.value)||0;pet.rainbowPct=Number(inRainbow.value)||0;pet.valueRegular=Number(inValReg.value)||0;pet.valueGold=Number(inValGold.value)||0;pet.valueRainbow=Number(inValRainbow.value)||0;save(S_EGGS,eggs);closeModal();render()}));cont.appendChild(btn('Cancel','',()=>closeModal()));openModal('Edit Pet',[cont])}

function renderPlay(){L.innerHTML='';L.appendChild(Object.assign(document.createElement('h3'),{textContent:'Play Mode'}));const nameIn=document.createElement('input');nameIn.placeholder='Player name';const moneyIn=document.createElement('input');moneyIn.type='number';moneyIn.value=100;L.appendChild(Object.assign(document.createElement('label'),{textContent:'Create Save (Account) name'}));L.appendChild(nameIn);L.appendChild(Object.assign(document.createElement('label'),{textContent:'Starting money'}));L.appendChild(moneyIn);const r=document.createElement('div');r.className='row';r.style.marginTop='8px';r.appendChild(btn('Create Account','primary',()=>{const name=nameIn.value.trim();const money=Number(moneyIn.value)||0;if(!name)return alert('Enter an account name');const a={id:uid('acc'),name,money,inventory:[],equippedPetId:null};accounts.push(a);save(S_ACCTS,accounts);selectedAccountId=a.id;render()}));r.appendChild(btn('Import accounts JSON','',()=>{const raw=prompt('Paste accounts JSON');try{const imp=JSON.parse(raw||'[]');accounts=imp;save(S_ACCTS,accounts);render()}catch(e){alert('Invalid JSON')}}));L.appendChild(r);L.appendChild(Object.assign(document.createElement('h4'),{textContent:'Your Accounts'}));const list=document.createElement('div');accounts.forEach(a=>{const d=document.createElement('div');d.className='acct-item row';if(a.id===selectedAccountId)d.style.outline='2px solid rgba(11,103,255,0.12)';d.innerHTML=`<div style="flex:1"><strong>${esc(a.name)}</strong><div class="small muted">Money: ${Number(a.money).toFixed(2)} • Pets: ${a.inventory.length}</div></div>`;const ctr=document.createElement('div');ctr.className='row';ctr.appendChild(btn('Play','',()=>{selectedAccountId=a.id;render()}));ctr.appendChild(btn('Delete','',()=>{if(confirm('Delete this account?')){accounts=accounts.filter(x=>x.id!==a.id);save(S_ACCTS,accounts);if(selectedAccountId===a.id)selectedAccountId=null;render()}}));d.appendChild(ctr);list.appendChild(d)});L.appendChild(list);if(selectedAccountId){const acc=accounts.find(a=>a.id===selectedAccountId);if(acc)renderPlayArea(acc);else{selectedAccountId=null;R.innerHTML='<div class="muted">Select an account</div>'}}else R.innerHTML='<div class="muted">Select an account to play</div>'}

function renderPlayArea(account){R.innerHTML='';R.appendChild(Object.assign(document.createElement('h3'),{innerHTML:`Playing: ${esc(account.name)} <span class="badge right">${Number(account.money).toFixed(2)} coins</span>`}));R.appendChild(Object.assign(document.createElement('label'),{textContent:'Shop'}));R.appendChild(btn('Open Shop','primary',()=>openShopModal(account)));
  const moneyRow=document.createElement('div');moneyRow.className='row';const moneyInput=document.createElement('input');moneyInput.type='number';moneyInput.step='0.01';moneyInput.placeholder='Amount';moneyInput.style.width='120px';moneyRow.appendChild(moneyInput);moneyRow.appendChild(btn('Add Money','',()=>{const amt=Number(moneyInput.value)||0;if(amt===0)return;const cur=document.querySelector('.inv-grid');if(cur)inventoryScroll[account.id]=cur.scrollTop||0;account.money+=amt;save(S_ACCTS,accounts);render()}));moneyRow.appendChild(btn('Subtract Money','',()=>{const amt=Number(moneyInput.value)||0;if(amt===0)return;const cur=document.querySelector('.inv-grid');if(cur)inventoryScroll[account.id]=cur.scrollTop||0;account.money-=amt;save(S_ACCTS,accounts);render()}));R.appendChild(moneyRow);
  R.appendChild(Object.assign(document.createElement('h4'),{textContent:'Inventory'}));const invGrid=document.createElement('div');invGrid.className='inv-grid';if(!account.inventory||!account.inventory.length)invGrid.innerHTML='<div class="muted">No pets in inventory.</div>';else account.inventory.forEach(p=>{const card=document.createElement('div');card.className='inv-card';const title=document.createElement('div');title.innerHTML=`<strong>${esc(p.name)}</strong>`;const meta=document.createElement('div');meta.className='small muted';meta.textContent=`${p.rarityText} • ${p.weight}kg • Value: ${getPetTradeValue(p)}`;const desc=document.createElement('div');desc.className='small';desc.textContent=p.description||'';const ctr=document.createElement('div');ctr.className='controls';ctr.appendChild(btn(account.equippedPetId===p.instanceId?'Equipped':'Equip','',()=>{account.equippedPetId=p.instanceId;save(S_ACCTS,accounts);render()}));ctr.appendChild(btn('Delete','',()=>{if(confirm('Delete this pet?')){account.inventory=account.inventory.filter(x=>x.instanceId!==p.instanceId);if(account.equippedPetId===p.instanceId)account.equippedPetId=null;save(S_ACCTS,accounts);render()}}));card.appendChild(title);card.appendChild(meta);card.appendChild(desc);card.appendChild(ctr);invGrid.appendChild(card)});R.appendChild(invGrid);if(inventoryScroll[account.id])try{invGrid.scrollTop=inventoryScroll[account.id]}catch(e){}
  R.appendChild(Object.assign(document.createElement('h4'),{textContent:'Actions'}));R.appendChild(btn('Earn Coins (tap)','primary',()=>{const earned=doEarn(account);if(earned<=0)alert('No pet equipped. Equip a pet to earn coins.');else{account.money+=earned;save(S_ACCTS,accounts);const cur=document.querySelector('.inv-grid');if(cur)inventoryScroll[account.id]=cur.scrollTop||0;render();alert('Earned '+earned.toFixed(2)+' coins')}}));R.appendChild(btn('Save Account','',()=>{save(S_ACCTS,accounts);alert('Saved')}));}

function openShopModal(account){const visibleEggs=eggs.filter(e=>e.visible===undefined?true:e.visible);const cont=document.createElement('div');if(!visibleEggs.length){cont.innerHTML='<div class="muted">No eggs available. Toggle in Create mode.</div>';openModal('Shop',[cont]);return}const grid=document.createElement('div');grid.className='shop-grid';visibleEggs.forEach(egg=>{const card=document.createElement('div');card.className='shop-card';card.appendChild(Object.assign(document.createElement('h4'),{textContent:`${egg.name} — ${egg.price} coins`}));const vis=document.createElement('div');vis.className='visibility-badge';vis.textContent=egg.visible?'Visible':'Hidden';card.appendChild(vis);const petList=document.createElement('div');petList.style.flex='1';if(!egg.pets||!egg.pets.length)petList.innerHTML='<div class="muted">No pets</div>';else egg.pets.forEach(p=>{const pdiv=document.createElement('div');pdiv.className='pet-line';pdiv.textContent=`${p.name} — ${p.rarityText} — ${p.rarityPct||0}% — Value: ${Number(p.valueRegular||0)}`;petList.appendChild(pdiv)});card.appendChild(petList);const row=document.createElement('div');row.className='row';row.appendChild(btn('Buy','primary',()=>{if(account.money<egg.price)return alert('Not enough coins');if(!egg.pets||!egg.pets.length)return alert('This egg has no pets');account.money-=egg.price;const result=rollPetFromEgg(egg);const variant=determineVariant(result);const weight=+(result.weightMin+Math.random()*(result.weightMax-result.weightMin)).toFixed(2);const instanceName=result.name+(variant?(' ('+variant+')'):'');const valueRegular=Number(result.valueRegular||0);const valueGold=Number(result.valueGold||0);const valueRainbow=Number(result.valueRainbow||0);const variantMultiplier=variant==='gold'?2:variant==='rainbow'?5:1;const inst={instanceId:uid('inst'),basePetId:result.id,name:instanceName,baseName:result.name,variant:variant,variantMultiplier:variantMultiplier,rarityText:result.rarityText,rarityPct:result.rarityPct,description:result.description,weight:weight,weightMin:result.weightMin,weightMax:result.weightMax,moneyPerTap:result.moneyPerTap,valueRegular:valueRegular,valueGold:valueGold,valueRainbow:valueRainbow,createdAt:Date.now()};account.inventory.push(inst);save(S_ACCTS,accounts);closeModal();render();alert(`You got: ${inst.name} (${inst.rarityText}) — ${inst.weight}kg`)}));row.appendChild(btn('Details','',()=>{const d=document.createElement('div');d.innerHTML=`<h4>${esc(egg.name)}</h4><div class="small muted">Price: ${egg.price} coins</div>`;const list=document.createElement('div');if(!egg.pets||!egg.pets.length)list.innerHTML='<div class="muted">No pets</div>';else egg.pets.forEach(p=>{const r=document.createElement('div');r.className='pet-line';r.textContent=`${p.name} — ${p.rarityText} — ${p.rarityPct||0}% — Value: ${Number(p.valueRegular||0)} / G:${Number(p.valueGold||0)} / R:${Number(p.valueRainbow||0)}`;list.appendChild(r)});d.appendChild(list);openModal('Egg details',[d])}));card.appendChild(row);grid.appendChild(card)});cont.appendChild(grid);openModal('Shop',[cont])}

function rollPetFromEgg(egg){const total=egg.pets.reduce((s,p)=>s+(p.rarityPct||0),0);let roll=Math.random()*100;if(total<=0)return egg.pets[Math.floor(Math.random()*egg.pets.length)];for(let p of egg.pets){if(roll<p.rarityPct)return p;roll-=p.rarityPct}return egg.pets[Math.floor(Math.random()*egg.pets.length)]}
function determineVariant(basePet){if((basePet.rainbowPct||0)>0 && Math.random()*100<basePet.rainbowPct)return 'rainbow';if((basePet.goldPct||0)>0 && Math.random()*100<basePet.goldPct)return 'gold';return null}
function getPetTradeValue(p){if(!p)return 0; if(p.variant==='gold')return Number(p.valueGold||0); if(p.variant==='rainbow')return Number(p.valueRainbow||0); return Number(p.valueRegular||0)}
function doEarn(account){const pet=account.inventory.find(p=>p.instanceId===account.equippedPetId);if(!pet)return 0;const base=Number(pet.moneyPerTap)||0;const minW=Number(pet.weightMin)||0;const w=Number(pet.weight)||minW;const extraKgs=Math.floor(Math.max(0,w-minW));const weightMultiplier=1+(0.10*extraKgs);const variantMultiplier=Number(pet.variantMultiplier)||(pet.variant==='gold'?2:pet.variant==='rainbow'?5:1);return+(base*weightMultiplier*variantMultiplier).toFixed(2)}

function renderTrade(){L.innerHTML='';L.appendChild(Object.assign(document.createElement('h3'),{textContent:'Trading Mode'}));const sel1=document.createElement('select');sel1.id='tradeAcc1';sel1.innerHTML='<option value="">-- Select --</option>'+accounts.map(a=>`<option value="${a.id}">${esc(a.name)}</option>`).join('');const sel2=document.createElement('select');sel2.id='tradeAcc2';sel2.innerHTML=sel1.innerHTML;L.appendChild(sel1);L.appendChild(sel2);L.appendChild(btn('Start Trade','primary',()=>startTrade()));R.innerHTML='<div class="muted">Choose two accounts and press Start Trade.</div>'}
function startTrade(){const sel1=document.getElementById('tradeAcc1'),sel2=document.getElementById('tradeAcc2');if(!sel1||!sel2)return alert('Trade selectors not found');const a1=accounts.find(x=>x.id===sel1.value),a2=accounts.find(x=>x.id===sel2.value);if(!a1||!a2||a1.id===a2.id)return alert('Choose two different accounts');trade={acc1:a1.id,acc2:a2.id,slots1:Array(9).fill(null),slots2:Array(9).fill(null)};drawTradeArea()}

function drawTradeArea(){const a1=accounts.find(x=>x.id===trade.acc1),a2=accounts.find(x=>x.id===trade.acc2);if(!a1||!a2){renderTrade();return}L.innerHTML=`<h3>Trading: ${esc(a1.name)} ⇄ ${esc(a2.name)}</h3><div class="muted">Place pets in slots, then Accept to trade.</div>`;R.innerHTML='';const container=document.createElement('div');container.className='row';container.style.justifyContent='space-between';const left=document.createElement('div');left.style.flex='1';left.style.marginRight='8px';const total1=computeSlotsValue(trade.slots1),total2=computeSlotsValue(trade.slots2);const acc1Net = total2 - total1;const acc2Net = total1 - total2;left.innerHTML=`<h4>${esc(a1.name)} <span class="small muted">— Offer value:</span> <span class="trade-total">${total1}</span> <span class="small">(<span class="${acc1Net>=0?"net-pos":"net-neg"}">${acc1Net>=0?"+"+acc1Net:acc1Net}</span>)</span></h4>`;const grid1=document.createElement('div');grid1.className='trade-grid';left.appendChild(grid1);left.appendChild(btn('Accept','',()=>alert(a1.name+' accepted (client-side)')));left.appendChild(btn('Decline','',()=>{alert(a1.name+' declined');renderTrade()}));const right=document.createElement('div');right.style.flex='1';right.style.marginLeft='8px';right.innerHTML=`<h4>${esc(a2.name)} <span class="small muted">— Offer value:</span> <span class="trade-total">${total2}</span> <span class="small">(<span class="${acc2Net>=0?"net-pos":"net-neg"}">${acc2Net>=0?"+"+acc2Net:acc2Net}</span>)</span></h4>`;const grid2=document.createElement('div');grid2.className='trade-grid';right.appendChild(grid2);right.appendChild(btn('Accept','',()=>alert(a2.name+' accepted (client-side)')));right.appendChild(btn('Decline','',()=>{alert(a2.name+' declined');renderTrade()}));container.appendChild(left);container.appendChild(right);R.appendChild(container);
  function drawGrid(gridEl,slots,acc){gridEl.innerHTML='';slots.forEach((s,idx)=>{const d=document.createElement('div');d.className='trade-slot'+(s?' filled':'');d.textContent=s?s.name:'+';d.addEventListener('click',()=>{if(s){slots[idx]=null;drawTradeArea()}else{if(!acc.inventory||!acc.inventory.length)return alert('This account has no pets');const used=(trade.slots1.concat(trade.slots2).filter(Boolean)).map(x=>x.instanceId);const nodes=acc.inventory.map(p=>{const div=document.createElement('div');div.className='inv-item';const w=(p.weight!==undefined&&p.weight!==null)?(Number(p.weight).toFixed(2)+'kg'):'';div.textContent=`${p.name} (${p.rarityText})${w?' — '+w:''} — Value: ${getPetTradeValue(p)}`;const already=used.includes(p.instanceId);if(already){div.style.opacity='0.5';div.style.cursor='not-allowed';const note=document.createElement('div');note.className='small muted';note.textContent='Already in trade';div.appendChild(note)}else{div.style.cursor='pointer';div.addEventListener('click',()=>{slots[idx]=p;closeModal();drawTradeArea()})}return div});openModal('Choose a pet to add',nodes)}});gridEl.appendChild(d)})}
  drawGrid(grid1,trade.slots1,a1);drawGrid(grid2,trade.slots2,a2);R.appendChild(btn('Finalize Trade','primary',()=>finalizeTrade()))}

function computeSlotsValue(slots){return slots.filter(Boolean).reduce((s,p)=>s+Number(getPetTradeValue(p)||0),0)}
function finalizeTrade(){const a1=accounts.find(x=>x.id===trade.acc1),a2=accounts.find(x=>x.id===trade.acc2);if(!a1||!a2)return;const p1=trade.slots1.filter(Boolean),p2=trade.slots2.filter(Boolean);p1.forEach(p=>{a1.inventory=a1.inventory.filter(x=>x.instanceId!==p.instanceId);a2.inventory.push(p)});p2.forEach(p=>{a2.inventory=a2.inventory.filter(x=>x.instanceId!==p.instanceId);a1.inventory.push(p)});save(S_ACCTS,accounts);alert('Trade complete!');trade={acc1:null,acc2:null,slots1:Array(9).fill(null),slots2:Array(9).fill(null)};render()}

bCreate.addEventListener('click',()=>{mode='create';render()});bPlay.addEventListener('click',()=>{mode='play';render()});bTrade.addEventListener('click',()=>{mode='trade';render()});
render();
</script>
</body>
</html>
